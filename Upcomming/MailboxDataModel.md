# Mailbox Module Data Model

This document outlines the database schema and storage conventions for the Mailpit-integrated mailbox module inside AssetManagement. The goal is to persist captured emails, track interactions, and support audits without bloating existing tables.

## Core Tables

### mailbox_messages
| Column | Type | Description |
| --- | --- | --- |
| `id` | ULID (string) | Primary key generated by Laravel. |
| `mailpit_id` | string | Mailpit message ID for deduplication and recovery. Indexed unique. |
| `subject` | string | Email subject (indexed for search). |
| `preview` | string (nullable) | Short text snippet extracted from the body. |
| `status` | enum (`new`, `processed`, `expired`) | Current lifecycle state; default `new`. |
| `environment` | string | Source environment tag (`local`, `staging`, `prod`). |
| `received_at` | timestamp | When Mailpit received the email. |
| `processed_at` | timestamp nullable | When staff marked the message handled. |
| `processed_by` | UUID nullable | References `users.id` for audit. |
| `size` | integer | Raw message size in bytes. |
| `html_body` | longtext encrypted | HTML content encrypted using Laravel casts. |
| `text_body` | longtext encrypted | Plain-text content encrypted. |
| `headers` | json encrypted | Captured headers for debugging. |
| `meta` | json | Additional metadata (tags, webhook payload). |
| `created_at` / `updated_at` | timestamps | Standard timestamps. |

**Indexes**: `mailpit_id` (unique), `status`, `environment`, `received_at`, composite `(subject, received_at)` for search.

### mailbox_recipients
| Column | Type | Description |
| --- | --- | --- |
| `id` | ULID | Primary key. |
| `message_id` | ULID | FK to `mailbox_messages.id`. Cascade delete. |
| `type` | enum (`to`, `cc`, `bcc`) | Recipient category. |
| `email` | string | Recipient address (indexed). |
| `name` | string nullable | Display name. |
| `created_at` / `updated_at` | timestamps | Standard timestamps. |

### mailbox_attachments
| Column | Type | Description |
| --- | --- | --- |
| `id` | ULID | Primary key. |
| `message_id` | ULID | FK to `mailbox_messages.id`. Cascade delete. |
| `filename` | string | Original attachment name. |
| `disk` | string | Laravel filesystem disk (`MAILBOX_STORAGE_DISK`). |
| `path` | string | Relative path to the stored file. |
| `mime_type` | string | Detected MIME type. |
| `size` | integer | Bytes. |
| `checksum` | string nullable | SHA-256 checksum for integrity. |
| `created_at` / `updated_at` | timestamps | Standard timestamps. |

### mailbox_events
| Column | Type | Description |
| --- | --- | --- |
| `id` | ULID | Primary key. |
| `message_id` | ULID | FK to `mailbox_messages.id`. Cascade delete. |
| `user_id` | UUID nullable | Authenticated user associated with the event. |
| `type` | enum (`viewed`, `processed`, `link_opened`, `note_added`, `purged`) | Event type. |
| `payload` | json | Context (IP, device, notes). |
| `created_at` | timestamp | Event timestamp. |

## Supporting Tables

### mailbox_notes (optional)
Allow staff to document manual actions.

| Column | Type | Description |
| --- | --- | --- |
| `id` | ULID | Primary key. |
| `message_id` | ULID | FK to `mailbox_messages`. |
| `user_id` | UUID | Author of the note. |
| `body` | text | Markdown note content. |
| `created_at` / `updated_at` | timestamps | Standard timestamps. |

### mailbox_tags (optional)
Support custom tagging if required later.

| Column | Type | Description |
| --- | --- | --- |
| `id` | ULID | Primary key. |
| `name` | string | Tag name (unique). |
| `created_at` / `updated_at` | timestamps | Standard timestamps. |

`mailbox_message_tag` pivot table would link `message_id` and `tag_id`.

## Storage Strategy
- **Encryption**: Use Laravel's `EncryptedCast` (or `AsEncryptedArrayObject`) for `html_body`, `text_body`, and `headers`. Alternatively, use `Crypt::encryptString` within an observer.
- **Filesystem**: Attachments save to the disk defined by `MAILBOX_STORAGE_DISK` (default `local`). Directory structure: `mailbox/{message_ulid}/{filename}`.
- **Retention**: Scheduler purges records older than `MAILBOX_RETENTION_DAYS` (default 7). Purge job removes attachments from disk and inserts an event with type `purged`.
- **Soft deletes**: Not required; use hard deletes plus audit events.

## Migration Checklist
1. Create migrations for `mailbox_messages`, `mailbox_recipients`, `mailbox_attachments`, `mailbox_events`, and optional `mailbox_notes`.
2. Apply indexes on search-heavy columns (`subject`, `email`, `status`, `received_at`).
3. Register foreign keys with `cascadeOnDelete()` to prevent orphaned records.
4. Add Eloquent models with appropriate relationships:
   - `MailboxMessage` hasMany `recipients`, `attachments`, `events`, `notes`.
   - `MailboxRecipient` belongsTo `MailboxMessage`.
   - `MailboxAttachment` belongsTo `MailboxMessage`.
   - `MailboxEvent` belongsTo `MailboxMessage` and optional `User`.
5. Implement attribute casts for encrypted columns and `received_at` timezone handling.

## Search Considerations
- Use Laravel Scout or database full-text indexes on `subject`, `preview`, `text_body` (if MySQL 5.7+/MariaDB) for keyword search.
- For small datasets, a simple `LIKE` search on `subject` and `preview` plus filtering is sufficient.
- Add computed `sender_email` column or join on `mailbox_recipients` with type `from` if you store sender separately.

## Next Steps
- Implement migrations and Eloquent models in the repository.
- Build the webhook ingestion job to populate these tables from Mailpit payloads.
- Expose repository/services to hydrate the Vue inbox and detail views.
